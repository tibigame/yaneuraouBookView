# 指定局面別テラショック定跡

## 概要

指定局面から掘り進めた定跡をテラショック定跡化しています。
ここでは定跡作成のためのノウハウを書いていきます。
定跡の成果はこちらを参照してください。
[横歩取り△４五角 (他横歩取り超急戦定跡)](https://github.com/tibigame/yaneuraouBookView/tree/master/book/yokofu_super_rapid)

* 作成したテラショック定跡は(yokofu_super_rapid-tera.db)
* ビルド前の定跡は(yokofu_super_rapid.db)
* 掘った局面集は(yokofu_super_rapid.sfen)
* 一部の長く掘る用の局面集は(yokofu_super_rapid2.sfen)

## テラショック定跡とは

長く掘り進めた定跡の末端を使ってMin-Maxすれば実質的に高いdepthでの探索になるのではという考え。  
でも労力が改善された訳ではなく、結局は普通に定跡を掘っていくしかないのだ。

### 基本的なやねうら王のコマンド

* 定跡を掘る

MultiPV 4、Hash なるべくたくさん。

makebook think yokofu_super_rapid.sfen yokofu_super_rapid.db startmoves 18 moves 54 depth 30 nodes 2000000000

* 定跡をビルドする

千日手が重要な定跡でなければ適当で良い。

makebook build_tree yokofu_super_rapid.db yokofu_super_rapid-tera.db black_contempt 150 white_contempt 150

## 定跡作成のノウハウ

### depthについて

* まず定跡局面での探索がその場で簡単に思考したレベルの深さでは意味がない。

	* なのでdepth=24は浅すぎるし、36は時間がかかりすぎるので30とした。

### プレイアウトを作る

* 本筋の変化の気になる局面から別種の評価関数で先後入れ替えで数十局程度10手ほど対局させる

	* ある程度指し手のランダム性がほしいので違う評価関数が良い。
	* ShogiGUIなどで棋譜保存させながら連続対局する。
	* 浅い探索だと意味がないから同時対局ではなくフルのコアを使って5秒程度の思考時間が良い。
	* Blunder.Converterでsfenに変換して局面のファイルに追加する。

このようにして望みの枝からのプレイアウトをたくさん作って定跡を掘る局面とする。

### はじめかた

* とりあえず初手からある手数までを掘ってみよう。これで1日あたり何局面掘れるのかもわかってくる。
* 途中終了させても*.db-30.dbなどとなっているファイルを新たに入力dbにすればファイルに書かれた所までは保存されている。
* ただし合法手がMultiPV未満の枝は再度掘らされるのでちょっとdbのdepthの所を+1とかにいじったり、プログラムの方を改造したりして対処。
* 局面集をファイル分けして特定の局面だけ長く掘るみたいな技が必要になる

### 結果の確認

やねうら定跡ビューワーに途中ファイルでもいいのでビルドした定跡ファイルを入れてみよう。

* form.tsxでキーとなる局面のsfenを設定しておくと楽
* ビューワーのsfen文字列は1度しか入れられないので再構築したい場合はリロードしてから
* 最善手の筋が左端に並ぶので掘り足りない枝はすぐにわかる
* 掘り足りない枝からプレイアウトを作るところに戻る

### 注意点

* 手順前後の局面に注意
先手がA、B、後手がC、Dでどの順番で指してもいいとき、  
ACBD、ADBCなどのすべての道を通って  
合流するところまでは棋譜で作っておかないといけない。  
不成とかMultiPVの外の手でそういうのが入ると途端に厄介。

* 予定の指し手がMultiPVの外→その局面だけMultiPVを上げて掘る。(普通はMultiPV4もあれば引っかかるはずなのでこれは例外のはず)

* いわゆる手が広い局面で無難な手を指す定跡を掘ってもマシンパワーがいくらあっても足りない。  
なのでお互いに一直線で斬り合うような変化を深く掘ってみよう。

* depth30とか36程度ですべてわかったつもりになってはいけないよ。
たとえばこの局面
[sfen +Rl1gk1snl/2s3g2/pN+Ppppp1p/9/B8/9/P2PPPP1P/1SG3+p2/LN2K1S+r+b b L4Pgn 41]
後手が500点ほど有利と読めるならたいしたものだ。

